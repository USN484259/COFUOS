     1                                  IA32_EFER equ 0xC0000080
     2                                  IA32_APIC_BASE equ 0x1B
     3                                  
     4                                  HIGHADDR equ 0xFFFF_8000_0000_0000
     5                                  
     6                                  IDT_BASE equ 0x0400
     7                                  IDT_LIM equ 0x400	;64 entries
     8                                  
     9                                  GDT_BASE equ 0x0800
    10                                  GDT_LIM equ 0x100	;16 entries
    11                                  TSS_BASE equ 0x0900
    12                                  TSS_LIM equ 0x80
    13                                  
    14                                  SYSINFO_BASE equ 0x0A00
    15                                  MPCTRL_BASE equ 0x1000
    16                                  
    17                                  PMMSCAN_BASE equ 0x1000
    18                                  
    19                                  PAGE_SIZE equ 0x1000
    20                                  SECTOR_SIZE equ 0x200
    21                                  
    22                                  ISR_STK equ 0x03000
    23                                  
    24                                  ISR_MP equ 0x9000
    25                                  
    26                                  PL4T equ 0x03000
    27                                  
    28                                  PDPT0 equ 0x4000
    29                                  PDPT8 equ 0x5000
    30                                  
    31                                  PDT0 equ 0x06000
    32                                  
    33                                  PT0	equ 0x07000
    34                                  
    35                                  PT_BASE equ 0x3000
    36                                  
    37                                  PT_PMM equ 0x8000
    38                                  
    39                                  PT_LEN equ (0x9000-PT_BASE)
    40                                  
    41                                  
    42                                  PMMWMP_PBASE equ 0x100000
    43                                  
    44                                  ;	physical Memory layout
    45                                  
    46                                  
    47                                  
    48                                  ;	000000		001000		R	TSS & GDT & IDT & sysinfo
    49                                  ;	001000		002000		RW CD WT	MP sync area
    50                                  ;	002000		003000		RWX	loader & ISR stack
    51                                  ;	003000		004000		RW	PL4T
    52                                  ;	004000		005000		RW	PDPT low
    53                                  ;	005000		006000		RW	PDPT high
    54                                  ;	006000		007000		RW	PDT
    55                                  ;	007000		008000		RW	PT
    56                                  ;	008000		009000		RW	PT for PMM
    57                                  ;	009000		010000		RW	MP ISR
    58                                  ;-------------direct map---------------------
    59                                  ;	010000		0A0000		?	avl
    60                                  
    61                                  ;	100000		?			RW	PMMWMP
    62                                  
    63                                  
    64                                  
    65                                  
    66                                  
    67                                  struc sysinfo
    68 00000000 <res 00000008>          .sig			resq 1
    69 00000008 <res 00000008>          .PMM_avl_top	resq 1
    70                                  
    71 00000010 <res 00000008>          .PMM_wmp_vbase	resq 1
    72 00000018 <res 00000004>          .PMM_wmp_page	resd 1
    73 0000001C <res 00000004>          .cpu			resd 1
    74                                  
    75 00000020 <res 00000002>          .bus			resw 1
    76 00000022 <res 0000000E>          .port			resw 7
    77                                  
    78 00000030 <res 00000002>          .VBE_bpp		resw 1
    79 00000032 <res 00000002>          .VBE_mode		resw 1
    80 00000034 <res 00000002>          .VBE_width		resw 1
    81 00000036 <res 00000002>          .VBE_height		resw 1
    82 00000038 <res 00000004>          .VBE_addr		resd 1
    83 0000003C <res 00000004>          .VBE_lim		resd 1
    84                                  
    85 00000040 <res 00000004>          .FAT_header		resd 1
    86 00000044 <res 00000004>          .FAT_table		resd 1
    87 00000048 <res 00000004>          .FAT_data		resd 1
    88 0000004C <res 00000004>          .FAT_cluster	resd 1
    89                                  
    90                                  .PE_filekrnl:
    91 00000050 <res 00000008>          .krnlbase		resq 1
    92 00000058 <res 00000004>          .AP_entry		resd 1
    93 0000005C <res 00000002>          .MP_cnt			resw 1
    94 0000005E <res 00000002>          				resw 1
    95                                  .MP_id:
    96                                  endstruc
    97                                  
    98                                  
    99                                  struc mpctrl
   100 00000000 <res 00000002>          .guard		resw 1
   101 00000002 <res 00000002>          .owner		resw 1
   102 00000004 <res 00000002>          .command	resw 1
   103 00000006 <res 00000002>          .count		resw 1
   104                                  endstruc
   105                                  
   106                                  
   107                                  
   108                                  
   109                                  section code vstart=0x2000
   110                                  
   111                                  [bits 16]
   112                                  
   113                                  
   114                                  
   115 00000000 0E                      push cs
   116 00000001 1F                      pop ds
   117 00000002 FC                      cld
   118                                  
   119 00000003 31C9                    xor cx,cx
   120 00000005 BB007C                  mov bx,0x7C00
   121 00000008 8EC1                    mov es,cx
   122                                  
   123                                  
   124                                  ;	ds	->	cur code segment
   125                                  ;	es	->	flat address
   126 0000000A 2681BFFE0155AA          cmp WORD [es:bx+0x200-2],0xAA55
   127 00000011 0F849801                jz near BSP_entry
   128                                  
   129 00000015 31D2                    xor dx,dx
   130 00000017 BB0010                  mov bx,MPCTRL_BASE+mpctrl.guard
   131 0000001A 42                      inc dx
   132                                  
   133                                  AP_entry:
   134                                  ;acquire lock
   135                                  
   136 0000001B 31C0                    xor ax,ax
   137 0000001D F390                    pause
   138 0000001F F0260FB117              lock cmpxchg [es:bx],dx
   139 00000024 75F5                    jnz AP_entry
   140                                  
   141                                  ;inc WORD [es:bx+2]	;MP_cnt
   142                                  
   143 00000026 8ED1                    mov ss,cx
   144 00000028 BC0030                  mov sp,ISR_STK
   145                                  
   146 0000002B BF5C0A                  mov di,SYSINFO_BASE+sysinfo.MP_cnt
   147                                  
   148 0000002E 26813D0800              cmp WORD [es:di],8
   149 00000033 0F82D202                jb near AP_PE	;currently support less than 8 processors
   150                                  
   151 00000037 31C0                    xor ax,ax
   152 00000039 F0268907                lock mov [es:bx],ax
   153                                  
   154 0000003D FA                      cli
   155                                  .reset:
   156 0000003E F4                      hlt
   157 0000003F EBFD                    jmp .reset
   158                                  
   159                                  
   160 00000041 90<rept>                align 4
   161                                  
   162 00000044 434F46554F53204C6F-     strboot db 'COFUOS Loading ...',0
   163 0000004D 6164696E67202E2E2E-
   164 00000056 00                 
   165 00000057 90                      align 4
   166 00000058 4E6F2070726F706572-     strvberr db 'No proper video mode',0
   167 00000061 20766964656F206D6F-
   168 0000006A 646500             
   169                                  
   170 0000006D 90<rept>                align 16
   171                                  
   172                                  gdt32_base:
   173 00000070 0000000000000000        dq 0	;first empty entrance
   174                                  
   175 00000078 FFFF                    dw 0xFFFF
   176 0000007A 0000                    dw 0
   177 0000007C 00                      db 0	;base addr
   178 0000007D 9A                      db 1001_1010_b
   179 0000007E CF                      db 1100_1111_b
   180 0000007F 00                      db 0		;sys cs
   181                                  
   182 00000080 FFFF                    dw 0xFFFF
   183 00000082 0000                    dw 0
   184 00000084 00                      db 0
   185 00000085 92                      db 1001_0010_b
   186 00000086 CF                      db 1100_1111_b
   187 00000087 00                      db 0		;sys ds
   188                                  
   189                                  
   190 00000088 0000000000000000        dq 0	;end of GDT
   191                                  
   192                                  gdt32_len equ ($-gdt32_base)
   193                                  
   194                                  gdt64_base:
   195                                  
   196                                  
   197 00000090 00000000                dd 0
   198 00000094 00982000                dd 0000_0000_0010_0000_1001_1000_0000_0000_b	;sys64 CS
   199                                  
   200 00000098 00000000                dd 0
   201 0000009C 00920000                dd 1001_0010_0000_0000_b	;sys64 DS
   202                                  
   203                                  
   204 000000A0 FFFF                    dw 0xFFFF
   205 000000A2 0000                    dw 0
   206 000000A4 00                      db 0
   207 000000A5 FA                      db 1111_1010_b
   208 000000A6 CF                      db 1100_1111_b
   209 000000A7 00                      db 0		;user cs
   210                                  
   211 000000A8 FFFF                    dw 0xFFFF
   212 000000AA 0000                    dw 0
   213 000000AC 00                      db 0
   214 000000AD F2                      db 1111_0010_b
   215 000000AE CF                      db 1100_1111_b
   216 000000AF 00                      db 0		;user ds
   217                                  
   218                                  
   219                                  
   220 000000B0 00000000                dd 0
   221 000000B4 00F82000                dd 0000_0000_0010_0000_1111_1000_0000_0000_b	;user64 CS
   222                                  
   223 000000B8 00000000                dd 0
   224 000000BC 00F20000                dd 1111_0010_0000_0000_b	;user64 DS
   225                                  
   226                                  
   227 000000C0 8000                    dw TSS_LIM
   228 000000C2 0009                    dw TSS_BASE
   229 000000C4 0089                    dw 0x8900
   230 000000C6 0000                    dw 0
   231 000000C8 0000000000000000        dq 0		;TSS
   232                                  
   233                                  
   234                                  
   235                                  gdt64_len equ ($-gdt64_base)
   236                                  
   237                                  GDT_TSS equ 7*8
   238                                  GDT_SYS_CS equ 1*8
   239                                  GDT_SYS_DS equ 2*8
   240                                  
   241                                  
   242                                  align 16
   243                                  
   244                                  
   245                                  tss64_base:
   246                                  
   247 000000D0 00000000                dd 0
   248 000000D4 003000000080FFFF        dq HIGHADDR+ISR_STK
   249 000000DC 0000000000000000        dq 0
   250 000000E4 0000000000000000        dq 0
   251 000000EC 0000000000000000        dq 0
   252 000000F4 00A000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*1
   253 000000FC 00B000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*2
   254 00000104 00C000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*3
   255 0000010C 00D000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*4
   256 00000114 00E000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*5
   257 0000011C 00F000000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*6
   258 00000124 000001000080FFFF        dq HIGHADDR+ISR_MP+PAGE_SIZE*7
   259 0000012C 0000000000000000        dq 0
   260 00000134 00000000                dd 0
   261                                  
   262                                  tss64_len equ ($-tss64_base)
   263                                  
   264                                  print16:
   265                                  
   266 00000138 B80003                  mov ax,0x0300
   267 0000013B 31DB                    xor bx,bx
   268 0000013D CD10                    int 0x10
   269                                  
   270 0000013F 31C9                    xor cx,cx
   271 00000141 89F5                    mov bp,si
   272 00000143 F7D1                    not cx
   273                                  .cnt:
   274 00000145 AC                      lodsb
   275 00000146 41                      inc cx
   276 00000147 84C0                    test al,al
   277 00000149 75FA                    jnz .cnt
   278                                  
   279 0000014B 06                      push es
   280 0000014C 1E                      push ds
   281 0000014D BB0F00                  mov bx,0x0F
   282 00000150 07                      pop es
   283                                  
   284 00000151 B80013                  mov ax,0x1300
   285 00000154 CD10                    int 0x10
   286                                  
   287 00000156 07                      pop es
   288                                  
   289 00000157 FEC6                    inc dh
   290 00000159 31DB                    xor bx,bx
   291 0000015B B80002                  mov ax,0x200
   292 0000015E CD10                    int 0x10
   293                                  
   294 00000160 C3                      ret
   295                                  
   296                                  
   297                                  
   298                                  
   299                                  abort16:
   300 00000161 E8D4FF                  call print16
   301 00000164 FB                      sti
   302                                  .hlt:
   303 00000165 F4                      hlt
   304 00000166 EBFD                    jmp .hlt
   305                                  
   306                                  
   307                                  
   308                                  set_PMM_top:	;si INFO	di PMMSCAN
   309                                  
   310 00000168 26668B4510              mov eax,[es:di+0x10]
   311 0000016D 6648                    dec eax
   312 0000016F 753B                    jnz .end
   313                                  
   314                                  
   315                                  
   316 00000171 26668B05                mov eax,[es:di]
   317 00000175 26668B4D04              mov ecx,[es:di+4]
   318                                  
   319 0000017A 2666034508              add eax,[es:di+8]
   320 0000017F 2666134D0C              adc ecx,[es:di+0x0C]
   321                                  
   322 00000184 26663B05                cmp eax,[es:di]
   323 00000188 750A                    jnz .nzero
   324 0000018A 26663B4D04              cmp ecx,[es:di+4]
   325 0000018F 7503                    jnz .nzero
   326                                  
   327 00000191 E91800                  jmp .end
   328                                  
   329                                  .nzero:
   330 00000194 26663B4C04              cmp ecx,[es:si+4]
   331 00000199 7211                    jb .end
   332 0000019B 7706                    ja .found
   333                                  
   334 0000019D 26663B04                cmp eax,[es:si]
   335 000001A1 7609                    jbe .end
   336                                  
   337                                  .found:
   338 000001A3 26668904                mov [es:si],eax
   339 000001A7 2666894C04              mov [es:si+4],ecx
   340                                  
   341                                  .end:
   342                                  
   343 000001AC C3                      ret
   344                                  
   345                                  
   346                                  BSP_entry:
   347 000001AD 8ED1                    mov ss,cx
   348 000001AF 89DC                    mov sp,bx	;0x7C00
   349                                  
   350                                  ;	ds	->	cur code segment
   351                                  ;	es	->	flat address
   352                                  
   353                                  
   354 000001B1 BE[4400]                mov si,strboot
   355 000001B4 E881FF                  call print16
   356                                  
   357                                  
   358                                  ;sysinfo setup
   359 000001B7 31C0                    xor ax,ax
   360 000001B9 BF000A                  mov di,SYSINFO_BASE
   361 000001BC B90004                  mov cx,0x800/2
   362 000001BF F3AB                    rep stosw
   363                                  
   364 000001C1 BF000A                  mov di,SYSINFO_BASE+sysinfo.sig
   365                                  
   366 000001C4 66B853595349            mov eax,'SYSI'
   367 000001CA 66AB                    stosd
   368 000001CC 66B84E464F00            mov eax,'NFO'
   369 000001D2 66AB                    stosd
   370                                  
   371 000001D4 BF200A                  mov di,SYSINFO_BASE+sysinfo.bus
   372 000001D7 B82420                  mov ax,0x2024
   373 000001DA AB                      stosw
   374                                  
   375 000001DB BF300A                  mov di,SYSINFO_BASE+sysinfo.VBE_bpp
   376 000001DE B81800                  mov ax,24
   377 000001E1 AB                      stosw
   378                                  
   379                                  
   380 000001E2 BEF07D                  mov si,0x7C00+0x200-0x10	;FAT_INFO from boot
   381 000001E5 BF400A                  mov di,SYSINFO_BASE+sysinfo.FAT_header
   382 000001E8 B90700                  mov cx,7
   383 000001EB F326A5                  es rep movsw
   384                                  
   385                                  
   386                                  
   387                                  ;detect VBE
   388 000001EE BF0012                  mov di,PMMSCAN_BASE+0x200
   389 000001F1 66B956424532            mov ecx,'VBE2'
   390 000001F7 66890D                  mov [di],ecx
   391 000001FA B8004F                  mov ax,0x4F00
   392 000001FD CD10                    int 0x10
   393 000001FF 3D4F00                  cmp ax,0x4F
   394 00000202 BE[5800]                mov si,strvberr
   395 00000205 0F8558FF                jnz abort16
   396                                  
   397                                  
   398 00000209 31C9                    xor cx,cx
   399 0000020B 8EC1                    mov es,cx
   400                                  
   401                                  
   402                                  
   403 0000020D 66BA56455341            mov edx,'VESA'
   404 00000213 266639160012            cmp [es:PMMSCAN_BASE+0x200],edx
   405 00000219 0F8544FF                jnz abort16
   406                                  
   407 0000021D 268B360E12              mov si,[es:PMMSCAN_BASE+0x200+0x0E]	;video modes offset
   408 00000222 268B0E1012              mov cx,[es:PMMSCAN_BASE+0x200+0x10]	;video modes segment
   409                                  
   410                                  
   411                                  ;	WARNING DS changed
   412 00000227 8ED9                    mov ds,cx
   413                                  
   414                                  
   415                                  video_loop:
   416 00000229 AD                      lodsw	;next mode
   417 0000022A 89C1                    mov cx,ax
   418 0000022C 89C3                    mov bx,ax
   419 0000022E 40                      inc ax
   420 0000022F 7473                    jz .end
   421                                  
   422                                  
   423                                  
   424 00000231 BF0010                  mov di,PMMSCAN_BASE
   425                                  
   426 00000234 B8014F                  mov ax,0x4F01
   427 00000237 CD10                    int 0x10	;query video mode
   428                                  
   429 00000239 31D2                    xor dx,dx
   430 0000023B 8EC2                    mov es,dx
   431                                  
   432 0000023D 3D4F00                  cmp ax,0x4F
   433 00000240 7562                    jnz .end
   434                                  
   435                                  
   436 00000242 26F606001080            test BYTE [es:PMMSCAN_BASE],0x80
   437 00000248 74DF                    jz video_loop
   438                                  
   439                                  
   440 0000024A 268B0E1210              mov cx,[es:PMMSCAN_BASE+0x12]
   441 0000024F 81F92003                cmp cx,800
   442 00000253 72D4                    jb video_loop
   443                                  
   444 00000255 268B161410              mov dx,[es:PMMSCAN_BASE+0x14]
   445 0000025A 81FA5802                cmp dx,600
   446 0000025E 72C9                    jb video_loop
   447                                  
   448                                  
   449                                  
   450                                  
   451 00000260 263B0E340A              cmp cx,[es:SYSINFO_BASE+sysinfo.VBE_width]
   452 00000265 72C2                    jb video_loop
   453 00000267 263B16360A              cmp dx,[es:SYSINFO_BASE+sysinfo.VBE_height]
   454 0000026C 72BB                    jb video_loop
   455                                  
   456 0000026E 260FB6061910            movzx ax,BYTE [es:PMMSCAN_BASE+0x19]
   457 00000274 263B06300A              cmp ax,[es:SYSINFO_BASE+sysinfo.VBE_bpp]
   458 00000279 72AE                    jb video_loop
   459                                  
   460                                  
   461                                  ;save current video mode
   462                                  
   463 0000027B BF300A                  mov di,SYSINFO_BASE+sysinfo.VBE_bpp
   464                                  
   465 0000027E AB                      stosw
   466                                  
   467 0000027F 93                      xchg ax,bx
   468 00000280 AB                      stosw
   469                                  
   470 00000281 89C8                    mov ax,cx
   471 00000283 AB                      stosw
   472                                  
   473 00000284 89D0                    mov ax,dx
   474 00000286 AB                      stosw
   475                                  
   476 00000287 F7E1                    mul cx
   477                                  
   478 00000289 66C1E210                shl edx,16
   479 0000028D C1EB03                  shr bx,3
   480 00000290 89C2                    mov dx,ax
   481                                  
   482                                  
   483                                  
   484                                  
   485                                  ;mov [es:VBE_width],ax
   486                                  ;mov [es:VBE_height],dx
   487                                  ;mov [es:VBE_bpp],bx
   488                                  
   489 00000292 2666A12810              mov eax,[es:PMMSCAN_BASE+0x28]
   490 00000297 66AB                    stosd
   491                                  
   492 00000299 660FB7C3                movzx eax,bx
   493 0000029D 66F7E2                  mul edx
   494                                  
   495                                  ;mov eax,[es:PMMSCAN_BASE+0x2C]
   496 000002A0 66AB                    stosd
   497                                  
   498                                  
   499 000002A2 EB85                    jmp video_loop
   500                                  
   501                                  .end:
   502                                  
   503 000002A4 0E                      push cs
   504 000002A5 1F                      pop ds
   505                                  
   506 000002A6 BE[5800]                mov si,strvberr
   507                                  
   508 000002A9 268B1E320A              mov bx,[es:SYSINFO_BASE+sysinfo.VBE_mode]
   509 000002AE 85DB                    test bx,bx
   510 000002B0 0F84ADFE                jz abort16
   511 000002B4 B8024F                  mov ax,0x4F02
   512 000002B7 81CB0040                or bx,0x4000	;LFB enable
   513 000002BB CD10                    int 0x10
   514 000002BD 3D4F00                  cmp ax,0x4F
   515 000002C0 0F859DFE                jnz abort16
   516                                  
   517                                  
   518                                  
   519 000002C4 6631DB                  xor ebx,ebx
   520                                  
   521                                  
   522 000002C7 31C0                    xor ax,ax
   523 000002C9 BF0010                  mov di,PMMSCAN_BASE
   524 000002CC B90008                  mov cx,0x800
   525 000002CF F3AB                    rep stosw		;clear memscan area
   526                                  
   527 000002D1 BE080A                  mov si,SYSINFO_BASE+sysinfo.PMM_avl_top
   528 000002D4 BF0010                  mov di,PMMSCAN_BASE
   529 000002D7 6689D9                  mov ecx,ebx
   530 000002DA 66BA50414D53            mov edx,0x534D4150	;'SMAP'
   531                                  
   532                                  
   533                                  ;	QWORD		base
   534                                  ;	QWORD		length
   535                                  ;	DWORD		type
   536                                  ;	BYTE[4]		alignment
   537                                  
   538                                  memscan_loop:
   539                                  ;mov edx,eax
   540 000002E0 B91400                  mov cx,20
   541 000002E3 66B820E80000            mov eax,0xE820
   542 000002E9 CD15                    int 0x15			;BIOS memory detection
   543 000002EB 720F                    jc .end
   544                                  
   545                                  ;get PMM_avl_top here
   546                                  
   547 000002ED 6689C2                  mov edx,eax
   548                                  
   549                                  
   550 000002F0 E875FE                  call set_PMM_top
   551                                  
   552                                  
   553 000002F3 81C71800                add di,24
   554 000002F7 6685DB                  test ebx,ebx
   555 000002FA 75E4                    jnz memscan_loop
   556                                  
   557                                  .end:
   558                                  
   559                                  ;align PMM_avl_top to 4K
   560                                  
   561 000002FC 26812400F0              and WORD [es:si],0xF000	;4K align
   562                                  
   563                                  
   564                                  ;notify BIOS of long mode
   565 00000301 B800EC                  mov ax,0xEC00
   566 00000304 BB0200                  mov bx,2
   567 00000307 CD15                    int 0x15
   568                                  
   569                                  
   570                                  
   571                                  
   572                                  AP_PE:
   573                                  
   574                                  
   575                                  ;A20 gate
   576 00000309 BA9200                  mov dx,0x92
   577 0000030C EC                      in al,dx
   578 0000030D 0C02                    or al,2
   579 0000030F EE                      out dx,al
   580                                  
   581                                  
   582 00000310 31C9                    xor cx,cx
   583 00000312 B8[7000]                mov ax,gdt32_base
   584 00000315 BA1F00                  mov dx,gdt32_len-1
   585 00000318 51                      push cx
   586 00000319 50                      push ax
   587 0000031A 52                      push dx
   588 0000031B 89E7                    mov di,sp
   589 0000031D 360F0115                lgdt [ss:di]
   590                                  
   591                                  ;	sp+0	WORD length-1
   592                                  ;	sp+2	DWORD linear base
   593                                  
   594                                  
   595                                  ;pg cd nw AM WP NE ET ts em MP PE
   596 00000321 66B833000500            mov eax,101_0000_0000_0011_0011_b
   597 00000327 0F22C0                  mov cr0,eax
   598                                  
   599                                  
   600 0000032A 66EA[47030000]0800      jmp DWORD 0x0008:pe_entry	;sys cs
   601                                  
   602 00000332 90<rept>                align 4
   603                                  
   604                                  [bits 32]
   605                                  
   606                                  abort:
   607 00000334 F4                      hlt
   608 00000335 EBFD                    jmp abort
   609                                  
   610                                  
   611                                  zeromemory:		;edi target		ecx size align to DWORD
   612 00000337 57                      push edi
   613                                  
   614 00000338 F6C103                  test cl,0011_b
   615 0000033B 75F7                    jnz abort
   616 0000033D 31C0                    xor eax,eax
   617 0000033F C1E902                  shr ecx,2
   618 00000342 FC                      cld
   619 00000343 F3AB                    rep stosd
   620                                  
   621 00000345 5F                      pop edi
   622 00000346 C3                      ret
   623                                  
   624                                  
   625                                  pe_entry:
   626                                  
   627                                  ;reload all segments
   628 00000347 66B81000                mov ax,0x10
   629 0000034B 8ED8                    mov ds,ax
   630 0000034D 8EC0                    mov es,ax
   631 0000034F 8EE0                    mov fs,ax
   632 00000351 8EE8                    mov gs,ax
   633 00000353 8ED0                    mov ss,ax
   634 00000355 BC00300000              mov esp,ISR_STK
   635 0000035A 89E5                    mov ebp,esp		;stack frame
   636                                  
   637                                  
   638                                  
   639 0000035C 6802002000              push 10_0000_0000_0000_0000_0010_b
   640 00000361 9D                      popfd
   641                                  
   642 00000362 B91B000000              mov ecx,IA32_APIC_BASE
   643 00000367 0F32                    rdmsr
   644                                  
   645 00000369 0FBAE008                bt eax,8	;BSP
   646 0000036D 0F83E4020000            jnc near AP_LM
   647                                  
   648                                  
   649                                  ;save ports
   650 00000373 BE00040000              mov esi,0x0400
   651 00000378 BF220A0000              mov edi,SYSINFO_BASE+sysinfo.port
   652 0000037D B907000000              mov ecx,7
   653 00000382 F366A5                  rep movsw
   654                                  
   655                                  ;check cpuid
   656 00000385 9C                      pushfd
   657 00000386 5A                      pop edx
   658 00000387 F7C200002000            test edx,1<<21
   659 0000038D 74A5                    jz abort
   660                                  
   661                                  
   662                                  
   663 0000038F 31C0                    xor eax,eax
   664 00000391 0FA2                    cpuid
   665                                  
   666 00000393 3C01                    cmp al,1
   667 00000395 729D                    jb abort
   668                                  
   669                                  
   670 00000397 3C07                    cmp al,7
   671 00000399 720F                    jb cpuid0_basic
   672                                  
   673 0000039B 31C9                    xor ecx,ecx
   674 0000039D B807000000              mov eax,7
   675 000003A2 0FA2                    cpuid
   676                                  
   677 000003A4 891D1C0A0000            mov [SYSINFO_BASE+sysinfo.cpu],ebx		;SMEP (SMAP INVPCID ?)
   678                                  
   679                                  cpuid0_basic:
   680                                  
   681 000003AA B801000000              mov eax,1
   682 000003AF 0FA2                    cpuid
   683                                  
   684                                  ;bt edx,16	;PAT	?
   685                                  ;jnc abort
   686                                  
   687 000003B1 0FBAE20F                bt edx,15	;cmovcc
   688 000003B5 0F8379FFFFFF            jnc abort
   689                                  
   690 000003BB 0FBAE20D                bt edx,13	;PGE
   691 000003BF 0F836FFFFFFF            jnc abort
   692                                  
   693 000003C5 0FBAE20B                bt edx,11	;SYSENTER
   694 000003C9 0F8365FFFFFF            jnc abort
   695                                  
   696 000003CF 0FBAE209                bt edx,9	;APIC
   697 000003D3 0F835BFFFFFF            jnc abort
   698                                  
   699 000003D9 0FBAE206                bt edx,6	;PAE
   700 000003DD 0F8351FFFFFF            jnc abort
   701                                  
   702 000003E3 0FBAE205                bt edx,5	;MSR
   703 000003E7 0F8347FFFFFF            jnc abort
   704                                  
   705                                  
   706 000003ED B800000080              mov eax,0x80000000
   707 000003F2 0FA2                    cpuid
   708                                  
   709 000003F4 3C01                    cmp al,1
   710 000003F6 0F8238FFFFFF            jb abort
   711                                  
   712                                  
   713 000003FC 3C08                    cmp al,8
   714 000003FE 720D                    jb cpuid8_basic
   715 00000400 B808000080              mov eax,0x80000008
   716 00000405 0FA2                    cpuid
   717                                  
   718 00000407 66A3200A0000            mov [SYSINFO_BASE+sysinfo.bus],ax	;MAXPHYADDR
   719                                  
   720                                  
   721                                  cpuid8_basic:
   722                                  
   723 0000040D B801000080              mov eax,0x80000001
   724 00000412 0FA2                    cpuid
   725                                  
   726 00000414 0FBAE21D                bt edx,29	;long mode
   727 00000418 0F8316FFFFFF            jnc abort
   728                                  
   729 0000041E 0FBAE214                bt edx,20	;NX
   730 00000422 0F830CFFFFFF            jnc abort
   731                                  
   732                                  ;TODO  test all necessary functionalities
   733                                  
   734                                  
   735                                  
   736                                  
   737                                  ;init GDT64
   738 00000428 BF00080000              mov edi,GDT_BASE
   739 0000042D B900010000              mov ecx,GDT_LIM
   740 00000432 E800FFFFFF              call zeromemory
   741                                  
   742 00000437 BE[90000000]            mov esi,gdt64_base
   743 0000043C BF08080000              mov edi,GDT_BASE+8
   744 00000441 B910000000              mov ecx,gdt64_len/4
   745 00000446 F3A5                    rep movsd
   746                                  
   747                                  ;init TSS
   748 00000448 BF00090000              mov edi,TSS_BASE
   749                                  
   750 0000044D BE[D0000000]            mov esi,tss64_base
   751 00000452 B91A000000              mov ecx,tss64_len/4
   752 00000457 F3A5                    rep movsd
   753                                  
   754                                  
   755                                  ;zeroing IDT
   756 00000459 BF00040000              mov edi,IDT_BASE
   757 0000045E B900040000              mov ecx,IDT_LIM
   758 00000463 E8CFFEFFFF              call zeromemory
   759                                  
   760                                  
   761                                  ;paging init
   762                                  
   763                                  
   764 00000468 BF00300000              mov edi,PT_BASE
   765 0000046D B900600000              mov ecx,PT_LEN
   766 00000472 E8C0FEFFFF              call zeromemory
   767                                  
   768 00000477 BF00300000              mov edi,PL4T
   769 0000047C 31C9                    xor ecx,ecx
   770 0000047E BB00400000              mov ebx,PDPT0
   771 00000483 BA03000000              mov edx,0x03
   772 00000488 41                      inc ecx
   773 00000489 E829020000              call map_page
   774                                  
   775 0000048E BF00380000              mov edi,PL4T+0x800
   776 00000493 BB00500000              mov ebx,PDPT8
   777 00000498 41                      inc ecx
   778 00000499 E819020000              call map_page
   779                                  
   780                                  
   781 0000049E BF00400000              mov edi,PDPT0
   782 000004A3 BB00600000              mov ebx,PDT0
   783 000004A8 41                      inc ecx
   784 000004A9 E809020000              call map_page
   785                                  
   786                                  
   787 000004AE BF00500000              mov edi,PDPT8
   788 000004B3 BB00600000              mov ebx,PDT0
   789 000004B8 41                      inc ecx
   790 000004B9 E8F9010000              call map_page
   791                                  
   792                                  
   793 000004BE BF00600000              mov edi,PDT0
   794 000004C3 BB00700000              mov ebx,PT0
   795 000004C8 41                      inc ecx
   796 000004C9 E8E9010000              call map_page
   797                                  
   798                                  
   799                                  
   800                                  
   801                                  
   802                                  
   803 000004CE BF00700000              mov edi,PT0
   804 000004D3 31DB                    xor ebx,ebx
   805 000004D5 BA03010080              mov edx,0x80000103
   806 000004DA 41                      inc ecx
   807 000004DB E8D7010000              call map_page
   808                                  
   809 000004E0 BB00100000              mov ebx,0x1000
   810 000004E5 BA1B010080              mov edx,0x8000011B	;CD WT
   811 000004EA 41                      inc ecx
   812 000004EB E8C7010000              call map_page
   813                                  
   814                                  
   815 000004F0 BB00200000              mov ebx,0x2000
   816 000004F5 BA03010000              mov edx,0x103
   817 000004FA 41                      inc ecx
   818 000004FB E8B7010000              call map_page
   819                                  
   820 00000500 BB00300000              mov ebx,PT_BASE
   821 00000505 BA03010080              mov edx,0x80000103
   822 0000050A B106                    mov cl,PT_LEN>>12
   823 0000050C E8A6010000              call map_page
   824                                  
   825                                  
   826                                  
   827                                  
   828                                  PMMWMP_init:
   829                                  
   830                                  ;init PDT here
   831                                  ;map PMMWMP to 0xFFFF8000_00200000
   832                                  
   833 00000511 BF08600000              mov edi,PDT0+8
   834 00000516 BB00800000              mov ebx,PT_PMM
   835 0000051B BA03000080              mov edx,0x80000003
   836 00000520 41                      inc ecx
   837 00000521 E891010000              call map_page
   838                                  
   839 00000526 8B0D080A0000            mov ecx,[SYSINFO_BASE+sysinfo.PMM_avl_top]
   840 0000052C A10C0A0000              mov eax,[SYSINFO_BASE+sysinfo.PMM_avl_top+4]
   841 00000531 F7C1FFFF7F00            test ecx,0x007FFFFF
   842                                  
   843 00000537 740B                    jz .nalign
   844                                  
   845 00000539 81C100008000            add ecx,0x00800000
   846 0000053F 1500000000              adc eax,0
   847                                  .nalign:
   848                                  
   849 00000544 0FACC117                shrd ecx,eax,23		;/0x800*0x1000
   850                                  
   851                                  ;ecx PMM page
   852 00000548 890D180A0000            mov [SYSINFO_BASE+sysinfo.PMM_wmp_page],ecx
   853                                  
   854                                  
   855                                  ;NOTE assume PMM less than 4G
   856 0000054E BF00800000              mov edi,PT_PMM
   857 00000553 81F900020000            cmp ecx,0x200
   858 00000559 BB00001000              mov ebx,PMMWMP_PBASE
   859 0000055E BA03010080              mov edx,0x80000103
   860 00000563 7606                    jbe .within4G
   861                                  
   862 00000565 E8(01040000)            call BugCheck
   863 0000056A CC                      int3
   864                                  .within4G:
   865 0000056B E847010000              call map_page
   866                                  
   867 00000570 8B1D180A0000            mov ebx,[SYSINFO_BASE+sysinfo.PMM_wmp_page]
   868 00000576 C1E30C                  shl ebx,12
   869 00000579 BF00001000              mov edi,PMMWMP_PBASE
   870 0000057E 89D9                    mov ecx,ebx
   871 00000580 E8B2FDFFFF              call zeromemory
   872                                  
   873 00000585 BEE80F0000              mov esi,PMMSCAN_BASE-24
   874 0000058A 01FB                    add ebx,edi
   875                                  
   876                                  ;ebx PMM limit
   877                                  
   878                                  .scan:
   879 0000058C 81C618000000            add esi,24
   880 00000592 BF00001000              mov edi,PMMWMP_PBASE
   881                                  
   882                                  
   883 00000597 8B5610                  mov edx,[esi+0x10]	;status
   884 0000059A 4A                      dec edx
   885                                  
   886 0000059B 8B06                    mov eax,[esi]
   887 0000059D 8B5604                  mov edx,[esi+4]
   888 000005A0 89C1                    mov ecx,eax
   889 000005A2 7446                    jz .avl
   890 000005A4 7905                    jns .rev
   891 000005A6 E98E000000              jmp .end
   892                                  
   893                                  .rev:
   894                                  ;reserved memory
   895                                  
   896 000005AB 0FACD00B                shrd eax,edx,12-1
   897                                  
   898 000005AF 01C7                    add edi,eax
   899 000005B1 39DF                    cmp edi,ebx
   900 000005B3 73D7                    jae .scan
   901                                  
   902                                  ;ecx=eax	edx not changed
   903 000005B5 034E08                  add ecx,[esi+8]
   904 000005B8 13560C                  adc edx,[esi+0x0C]
   905                                  
   906 000005BB 66F7C1FF0F              test cx,0x0FFF
   907 000005C0 740C                    jz .rev_noalign
   908 000005C2 81C100100000            add ecx,0x1000
   909 000005C8 81D200000000            adc edx,0
   910                                  .rev_noalign:
   911 000005CE 0FACD10B                shrd ecx,edx,12-1
   912                                  
   913 000005D2 81C100001000            add ecx,PMMWMP_PBASE
   914                                  
   915 000005D8 39D9                    cmp ecx,ebx
   916 000005DA 0F43CB                  cmovae ecx,ebx
   917                                  
   918 000005DD 29F9                    sub ecx,edi
   919 000005DF 66B8FF7F                mov ax,0x7FFF
   920 000005E3 D1E9                    shr ecx,1
   921 000005E5 F366AB                  rep stosw
   922                                  
   923 000005E8 EBA2                    jmp .scan
   924                                  
   925                                  .avl:
   926                                  ;available memory
   927 000005EA 66A9FF0F                test ax,0x0FFF
   928 000005EE 740B                    jz .avl_noalign
   929 000005F0 0500100000              add eax,0x1000
   930 000005F5 81D200000000            adc edx,0
   931                                  .avl_noalign:
   932 000005FB 0FACD00B                shrd eax,edx,12-1
   933 000005FF 01C7                    add edi,eax
   934 00000601 39DF                    cmp edi,ebx
   935 00000603 7387                    jae .scan
   936                                  
   937                                  ;ecx=eax	edx not changed
   938 00000605 034E08                  add ecx,[esi+8]
   939 00000608 13560C                  adc edx,[esi+0x0C]
   940                                  
   941 0000060B 0FACD10B                shrd ecx,edx,12-1
   942                                  
   943 0000060F 81C100001000            add ecx,PMMWMP_PBASE
   944                                  
   945 00000615 39D9                    cmp ecx,ebx
   946 00000617 0F43CB                  cmovae ecx,ebx
   947                                  
   948 0000061A 29F9                    sub ecx,edi
   949 0000061C 66B80080                mov ax,0x8000
   950 00000620 D1E9                    shr ecx,1
   951                                  
   952                                  .avl_set:
   953 00000622 66813F0000              cmp WORD [edi],0
   954 00000627 7503                    jnz .avl_nop
   955                                  
   956 00000629 668907                  mov [edi],ax
   957                                  
   958                                  .avl_nop:
   959 0000062C 81C702000000            add edi,2
   960 00000632 E2EE                    loop .avl_set
   961                                  
   962                                  
   963 00000634 E953FFFFFF              jmp .scan
   964                                  
   965                                  .end:
   966                                  
   967                                  ;set current state of PMM
   968 00000639 6631C0                  xor ax,ax
   969 0000063C BF00001000              mov edi,PMMWMP_PBASE
   970 00000641 B910000000              mov ecx,0x10
   971 00000646 F366AB                  rep stosw
   972                                  
   973 00000649 BF00021000              mov edi,PMMWMP_PBASE+2*0x100
   974 0000064E 8B0D180A0000            mov ecx,[SYSINFO_BASE+sysinfo.PMM_wmp_page]
   975 00000654 F366AB                  rep stosw
   976                                  
   977                                  AP_LM:
   978                                  
   979 00000657 0F20E0                  mov eax,cr4
   980 0000065A 0FBAE805                bts eax,5	;PAE
   981 0000065E 0FBAE809                bts eax,9	;OSFXSR
   982 00000662 0FBAE80A                bts eax,10	;OSXMMEXCPT
   983 00000666 0F22E0                  mov cr4,eax
   984                                  
   985 00000669 B9800000C0              mov ecx,IA32_EFER
   986 0000066E 0F32                    rdmsr
   987 00000670 660D0109                or ax,0000_1001_0000_0001_b		;NXE LME SCE
   988 00000674 0F30                    wrmsr
   989                                  
   990                                  
   991                                  
   992 00000676 B800300000              mov eax,PL4T
   993 0000067B 0F22D8                  mov cr3,eax
   994                                  
   995                                  ;enable PG
   996 0000067E 0F20C0                  mov eax,cr0
   997 00000681 0FBAE81F                bts eax,31
   998 00000685 0F22C0                  mov cr0,eax
   999                                  
  1000                                  
  1001                                  ;test LMA
  1002                                  
  1003 00000688 B9800000C0              mov ecx,IA32_EFER
  1004 0000068D 0F32                    rdmsr
  1005 0000068F 0FBAE00A                bt eax,10
  1006 00000693 0F839BFCFFFF            jnc abort
  1007                                  
  1008                                  
  1009                                  ;load GDTR and jmp to 64-bit mode
  1010                                  ;xor eax,eax
  1011 00000699 B80080FFFF              mov eax,0xFFFF8000
  1012 0000069E BA00080000              mov edx,GDT_BASE
  1013 000006A3 B90000FF00              mov ecx,(GDT_LIM-1)<<16
  1014 000006A8 50                      push eax
  1015 000006A9 52                      push edx
  1016 000006AA 51                      push ecx
  1017 000006AB 0F01542402              lgdt [esp+2]
  1018                                  
  1019                                  
  1020 000006B0 EA[E0060000]0800        jmp DWORD GDT_SYS_CS:LM_entry
  1021                                  
  1022                                  
  1023                                  map_page:	;edi PT		ebx PMM		ecx cnt		edx attrib
  1024                                  
  1025 000006B7 89D8                    mov eax,ebx
  1026 000006B9 31DB                    xor ebx,ebx
  1027 000006BB 6609D0                  or ax,dx
  1028                                  ;mov al,dl
  1029                                  
  1030 000006BE 0FBAE21F                bt edx,31
  1031 000006C2 D1DB                    rcr ebx,1
  1032                                  
  1033                                  .st:
  1034                                  
  1035 000006C4 AB                      stosd
  1036 000006C5 0500100000              add eax,0x1000
  1037 000006CA 891F                    mov [edi],ebx
  1038 000006CC 81C704000000            add edi,4
  1039                                  
  1040 000006D2 E2F0                    loop .st
  1041                                  
  1042 000006D4 C3                      ret
  1043                                  
  1044                                  
  1045                                  [bits 64]
  1046                                  
  1047                                  PMMWMP_VBASE equ HIGHADDR+0x00200000
  1048                                  KRNL_VBASE equ HIGHADDR+0x02000000
  1049                                  
  1050                                  TMP_PT_VBASE equ HIGHADDR+0x10000
  1051                                  CMN_BUF_VBASE equ HIGHADDR+0x11000
  1052                                  PT_MAP_PT equ PT0+8*0x10
  1053                                  BUF_MAP_PT equ PT0+8*0x11
  1054                                  
  1055                                  KRNL_STK_GUARD equ HIGHADDR+0x1FF000
  1056                                  KRNL_STK_TOP equ KRNL_STK_GUARD
  1057                                  
  1058                                  
  1059                                  
  1060                                  ;PDPT	0x100 pages
  1061                                  ;PDT	0x20000 pages
  1062                                  ;2M alignment 
  1063                                  
  1064                                  
  1065                                  ;	virtual address of HIGHADDR
  1066                                  ;	00000000	00010000	lowPMM
  1067                                  ;	00010000	0001C000	VMG info
  1068                                  ;	00010000	00011000	TMP_PT
  1069                                  ;	00011000	?			CMN_BUF
  1070                                  ;	?			00200000	krnlstk for all MPs
  1071                                  ;	00200000	?			PMMWMP
  1072                                  ;-------------------------------	?			01000000	krnlheap ?
  1073                                  ;-------------------------------	01000000	02000000	PDPTmap
  1074                                  ;	?			01FFF000	stack
  1075                                  ;	02000000	?			KERNEL
  1076                                  ;-------------------------------	20000000	40000000	PDTmap
  1077                                  
  1078                                  
  1079                                  
  1080                                  struc peinfo
  1081 00000000 <res 00000008>          .headerpmm	resq 1
  1082 00000008 <res 00000008>          .vbase		resq 1
  1083 00000010 <res 00000004>          .entry		resd 1
  1084 00000014 <res 00000002>          .section	resw 1
  1085 00000016 <res 00000002>          .sec_attrib	resw 1
  1086 00000018 <res 00000004>          .sec_size	resd 1
  1087 0000001C <res 00000004>          .sec_off	resd 1
  1088                                  endstruc
  1089                                  
  1090                                  
  1091                                  
  1092 000006D5 90<rept>                align 16
  1093                                  
  1094                                  LM_entry:
  1095                                  
  1096                                  
  1097 000006E0 66B81000                mov ax,GDT_SYS_DS
  1098 000006E4 8ED8                    mov ds,ax
  1099 000006E6 8EC0                    mov es,ax
  1100 000006E8 8EE0                    mov fs,ax
  1101 000006EA 8EE8                    mov gs,ax
  1102 000006EC 8ED0                    mov ss,ax
  1103 000006EE 48BC003000000080FF-     mov rsp,HIGHADDR+ISR_STK
  1104 000006F7 FF                 
  1105                                  ;mov rbp,rsp
  1106                                  
  1107 000006F8 48BA-                   mov rdx,LM_high
  1108 000006FA [1000000000000000] 
  1109                                  
  1110 00000702 48FFE2                  jmp rdx
  1111                                  
  1112 00000705 90<rept>                align 4
  1113                                  
  1114                                  CODE64OFF equ ($-$$)
  1115                                  
  1116                                  section codehigh vstart=0xFFFF8000_00002000+CODE64OFF
  1117                                  
  1118                                  
  1119                                  TR_selector:
  1120 00000000 3800                    dw GDT_TSS
  1121                                  
  1122 00000002 90<rept>                align 4
  1123                                  
  1124 00000004 434F46554F53202053-     strkrnl db 'COFUOS',0x20,0x20,'SYS',0
  1125 0000000D 595300             
  1126                                  
  1127                                  align 8
  1128                                  
  1129                                  LM_high:
  1130                                  
  1131 00000010 48BA-                   mov rdx,TR_selector
  1132 00000012 [0000000000000000] 
  1133 0000001A 0F001A                  ltr [rdx]
  1134                                  
  1135                                  
  1136                                  ;unmap lowaddr
  1137                                  ;mov rdi,HIGHADDR+PDPT0
  1138                                  ;xor rax,rax
  1139                                  ;stosq
  1140                                  
  1141                                  ;ebable PGE SMEP disable WRGSBASE
  1142                                  
  1143                                  ;mov rsi,HIGHADDR+SYSINFO_BASE+sysinfo.cpu
  1144 0000001D 418B44241C              mov eax,[r12+sysinfo.cpu]
  1145 00000022 0F20E2                  mov rdx,cr4
  1146                                  ;lodsd
  1147 00000025 0FBAE007                bt eax,7
  1148 00000029 7305                    jnc .nosmep
  1149 0000002B 480FBAEA14              bts rdx,20	;SMEP
  1150                                  
  1151                                  .nosmep:
  1152 00000030 480FBAEA07              bts rdx,7	;PGE
  1153 00000035 480FBAF210              btr rdx,16	;FSGSBASE
  1154                                  
  1155 0000003A 0F22E2                  mov cr4,rdx
  1156                                  
  1157                                  ;no need to reload CR3 since setting PGE flushs TLB
  1158                                  ;mov rdx,cr3
  1159                                  ;mov cr3,rdx
  1160                                  
  1161 0000003D 49BC000A00000080FF-     mov r12,HIGHADDR+SYSINFO_BASE
  1162 00000046 FF                 
  1163                                  
  1164                                  
  1165 00000047 B91B000000              mov ecx,IA32_APIC_BASE
  1166 0000004C 0F32                    rdmsr
  1167                                  
  1168 0000004E 0FBAE008                bt eax,8	;BSP
  1169 00000052 7225                    jc .BSP
  1170                                  
  1171                                  
  1172                                  
  1173                                  
  1174 00000054 418B4C2458              mov ecx,[r12+sysinfo.AP_entry]
  1175 00000059 498B542450              mov rdx,[r12+sysinfo.krnlbase]
  1176 0000005E 4889E5                  mov rbp,rsp
  1177 00000061 4801CA                  add rdx,rcx
  1178 00000064 4881EC20000000          sub rsp,0x20
  1179 0000006B 490FB74C245C            movzx rcx,WORD [r12+sysinfo.MP_cnt]
  1180 00000071 48FFD2                  call rdx
  1181                                  
  1182 00000074 E988030000              jmp BugCheck
  1183                                  
  1184                                  
  1185                                  .BSP:
  1186                                  
  1187                                  
  1188                                  
  1189                                  ;mov rcx,HIGHADDR+SYSINFO_BASE+sysinfo.PMM_wmp_vbase
  1190 00000079 48B8000020000080FF-     mov rax,PMMWMP_VBASE
  1191 00000082 FF                 
  1192 00000083 4989442410              mov [r12+sysinfo.PMM_wmp_vbase],rax
  1193                                  
  1194                                  ;mov rcx,HIGHADDR+SYSINFO_BASE+sysinfo.FAT_cluster
  1195 00000088 66418B44244C            mov ax,[r12+sysinfo.FAT_cluster]
  1196 0000008E 663D0800                cmp ax,8
  1197 00000092 7606                    jbe .unmap_low
  1198                                  
  1199 00000094 E868030000              call BugCheck
  1200 00000099 CC                      int3
  1201                                  .unmap_low:
  1202                                  
  1203                                  
  1204                                  
  1205                                  
  1206                                  
  1207 0000009A 4889E5                  mov rbp,rsp
  1208 0000009D 4881EC20000000          sub rsp,0x20
  1209                                  
  1210                                  
  1211 000000A4 E83D040000              call PmmAlloc
  1212 000000A9 48BE001001000080FF-     mov rsi,CMN_BUF_VBASE
  1213 000000B2 FF                 
  1214 000000B3 4889C2                  mov rdx,rax
  1215 000000B6 4889F1                  mov rcx,rsi
  1216 000000B9 49B803000000000000-     mov r8,0x80000000_00000003
  1217 000000C2 80                 
  1218                                  ;mov r12,rax		;r12 PMM
  1219 000000C3 48890424                mov [rsp+peinfo.headerpmm],rax
  1220 000000C7 E85F040000              call MapPage
  1221                                  
  1222                                  find_krnl:
  1223                                  ;xor rdx,rdx
  1224 000000CC 4D31C0                  xor r8,r8
  1225 000000CF 4889F1                  mov rcx,rsi
  1226 000000D2 418B542448              mov edx,[r12+sysinfo.FAT_data]
  1227 000000D7 49FFC0                  inc r8
  1228 000000DA E82D030000              call ReadSector
  1229                                  
  1230 000000DF 48BB00020000000000-     mov rbx,SECTOR_SIZE
  1231 000000E8 00                 
  1232 000000E9 4831C9                  xor rcx,rcx
  1233 000000EC 4801F3                  add rbx,rsi
  1234                                  ;xor rax,rax
  1235                                  
  1236 000000EF E911000000              jmp .findfile
  1237                                  
  1238                                  .fail:
  1239 000000F4 E808030000              call BugCheck
  1240 000000F9 CC                      int3
  1241                                  
  1242                                  .next:
  1243 000000FA 4881C620000000          add rsi,0x20
  1244 00000101 4080E6E0                and sil,(~ 0x1F)
  1245                                  
  1246                                  .findfile:
  1247                                  
  1248 00000105 4839DE                  cmp rsi,rbx
  1249 00000108 73EA                    jae .fail
  1250                                  
  1251 0000010A 803E00                  cmp BYTE [rsi],0
  1252 0000010D 74E5                    jz .fail
  1253                                  
  1254 0000010F 48BF-                   mov rdi,strkrnl
  1255 00000111 [0400000000000000] 
  1256 00000119 B10B                    mov cl,11
  1257                                  
  1258                                  .name:
  1259 0000011B AC                      lodsb
  1260 0000011C 3207                    xor al,[rdi]
  1261 0000011E A8DF                    test al,(~ 0x20)
  1262 00000120 75D8                    jnz .next
  1263 00000122 48FFC7                  inc rdi
  1264 00000125 E2F4                    loop .name
  1265                                  
  1266 00000127 AC                      lodsb
  1267 00000128 A810                    test al,0x10
  1268 0000012A 75C8                    jnz .fail
  1269                                  
  1270 0000012C 4881C608000000          add rsi,8
  1271 00000133 66AD                    lodsw
  1272 00000135 C1E010                  shl eax,16
  1273 00000138 4881C604000000          add rsi,4
  1274 0000013F 66AD                    lodsw
  1275                                  
  1276                                  ;rax firstcluster
  1277                                  
  1278 00000141 4885C0                  test rax,rax
  1279 00000144 74AE                    jz .fail
  1280                                  
  1281 00000146 3DF8FFFF0F              cmp eax,0x0FFFFFF8
  1282 0000014B 73A7                    jae .fail
  1283                                  
  1284 0000014D 48BF500A00000080FF-     mov rdi,HIGHADDR+SYSINFO_BASE+sysinfo.PE_filekrnl
  1285 00000156 FF                 
  1286 00000157 48BE001001000080FF-     mov rsi,CMN_BUF_VBASE
  1287 00000160 FF                 
  1288                                  
  1289                                  .load_cluster:
  1290                                  
  1291 00000161 4831D2                  xor rdx,rdx
  1292 00000164 B980000000              mov ecx,128
  1293 00000169 AB                      stosd
  1294 0000016A 4D31C0                  xor r8,r8
  1295 0000016D F7F1                    div ecx
  1296                                  ;mov r9,HIGHADDR+SYSINFO_BASE+sysinfo.FAT_table
  1297 0000016F 4889D3                  mov rbx,rdx		;remainder
  1298 00000172 4889F1                  mov rcx,rsi
  1299 00000175 4889C2                  mov rdx,rax
  1300 00000178 49FFC0                  inc r8
  1301 0000017B 4103542444              add edx,[r12+sysinfo.FAT_table]
  1302                                  
  1303 00000180 E887020000              call ReadSector
  1304                                  
  1305 00000185 8B049E                  mov eax,[rsi+4*rbx]
  1306                                  
  1307 00000188 85C0                    test eax,eax
  1308 0000018A 0F8464FFFFFF            jz .fail
  1309                                  
  1310 00000190 3DF8FFFF0F              cmp eax,0x0FFFFFF8
  1311 00000195 72CA                    jb .load_cluster
  1312                                  
  1313                                  
  1314                                  
  1315 00000197 4889F1                  mov rcx,rsi
  1316 0000019A 4831D2                  xor rdx,rdx
  1317 0000019D 4889F7                  mov rdi,rsi
  1318 000001A0 49B800020000000000-     mov r8,SECTOR_SIZE
  1319 000001A9 00                 
  1320 000001AA E8C0020000              call ReadFile
  1321 000001AF 4801C7                  add rdi,rax
  1322                                  
  1323                                  
  1324                                  ;verify PE header
  1325 000001B2 668B06                  mov ax,[rsi]
  1326                                  ;xor rdx,rdx
  1327 000001B5 663D4D5A                cmp ax,'MZ'
  1328 000001B9 0F8535FFFFFF            jnz .fail
  1329                                  
  1330 000001BF 8B563C                  mov edx,[rsi+0x3C]
  1331 000001C2 4801D6                  add rsi,rdx
  1332                                  
  1333 000001C5 AD                      lodsd
  1334 000001C6 3D50450000              cmp eax,'PE'
  1335 000001CB 0F8523FFFFFF            jnz .fail
  1336                                  
  1337 000001D1 66AD                    lodsw	;machine
  1338 000001D3 663D6486                cmp ax,0x8664
  1339 000001D7 0F8517FFFFFF            jnz near .fail
  1340                                  
  1341 000001DD 66AD                    lodsw	;section count
  1342 000001DF 4881C60C000000          add rsi,0x0C
  1343 000001E6 6685C0                  test ax,ax
  1344 000001E9 6689442414              mov [rsp+peinfo.section],ax
  1345 000001EE 0F8400FFFFFF            jz .fail
  1346                                  
  1347 000001F4 66AD                    lodsw	;opt header size
  1348 000001F6 663DF000                cmp ax,0xF0
  1349 000001FA 0F85F4FEFFFF            jnz .fail
  1350 00000200 66AD                    lodsw	;Characteristics
  1351 00000202 660FBAE001              bt ax,1		;executable
  1352 00000207 0F83E7FEFFFF            jnc .fail
  1353                                  
  1354                                  ;SYSTEM flag may be deprecated
  1355                                  
  1356                                  ;bt ax,12	;SYSTEM
  1357                                  ;nc near .fail
  1358                                  
  1359 0000020D AD                      lodsd
  1360 0000020E 4881C60C000000          add rsi,0x0C
  1361 00000215 663D0B02                cmp ax,0x20B
  1362 00000219 0F85D5FEFFFF            jnz .fail
  1363                                  
  1364 0000021F AD                      lodsd	;entrypoint RVA
  1365 00000220 89442410                mov [rsp+peinfo.entry],eax
  1366                                  
  1367 00000224 AD                      lodsd
  1368 00000225 48AD                    lodsq	;vbase
  1369 00000227 4889442408              mov [rsp+peinfo.vbase],rax
  1370                                  
  1371 0000022C AD                      lodsd	;section alignment
  1372 0000022D 4881C618000000          add rsi,0x18
  1373 00000234 A9FF0F0000              test eax,(PAGE_SIZE-1)
  1374 00000239 0F85B5FEFFFF            jnz .fail
  1375                                  ;lodsd	;file alignment
  1376                                  ;add rsi,0x14
  1377                                  ;mov [rsp+peinfo.filealign],ax	;needed ?
  1378                                  
  1379                                  ;xor rbx,rbx
  1380                                  
  1381 0000023F AD                      lodsd	;header size
  1382                                  ;xor r8,r8
  1383 00000240 4839FE                  cmp rsi,rdi
  1384 00000243 0F83ABFEFFFF            jae .fail
  1385                                  
  1386 00000249 2D00020000              sub eax,SECTOR_SIZE
  1387                                  ;mov rdx,r8
  1388 0000024E 7613                    jbe .smallheader
  1389                                  
  1390 00000250 4889F9                  mov rcx,rdi
  1391 00000253 BA00020000              mov edx,SECTOR_SIZE
  1392 00000258 4189C0                  mov r8d,eax
  1393 0000025B E80F020000              call ReadFile
  1394 00000260 4801C7                  add rdi,rax
  1395                                  
  1396                                  .smallheader:
  1397                                  
  1398                                  
  1399 00000263 AD                      lodsd
  1400 00000264 AD                      lodsd	;(DLLCharacteristics<<16) | Subsystem
  1401 00000265 0FBAE018                bt eax,24	;DEP
  1402 00000269 0F8385FEFFFF            jnc .fail
  1403                                  
  1404                                  
  1405                                  ;map vbase and stack
  1406                                  ;rbx cluster size
  1407                                  
  1408 0000026F AD                      lodsd	;stkrev
  1409                                  
  1410 00000270 3D00001000              cmp eax,0x100000	;1M
  1411 00000275 89C2                    mov edx,eax
  1412 00000277 0F8777FEFFFF            ja .fail
  1413                                  
  1414 0000027D AD                      lodsd	;stkrev high
  1415 0000027E 85C0                    test eax,eax
  1416 00000280 0F856EFEFFFF            jnz .fail
  1417                                  
  1418 00000286 AD                      lodsd	;stkcmt
  1419 00000287 39D0                    cmp eax,edx
  1420 00000289 48BF00F01F000080FF-     mov rdi,KRNL_STK_TOP
  1421 00000292 FF                 
  1422 00000293 0F875BFEFFFF            ja .fail
  1423 00000299 89C3                    mov ebx,eax
  1424                                  
  1425 0000029B AD                      lodsd	;stkcmt high
  1426                                  
  1427 0000029C C1EB0C                  shr ebx,12	;rbx commit page count
  1428 0000029F 85C0                    test eax,eax
  1429 000002A1 0F854DFEFFFF            jnz .fail
  1430                                  
  1431 000002A7 81FB10000000            cmp ebx,0x10	;16 pages
  1432 000002AD 0F8741FEFFFF            ja .fail
  1433                                  
  1434                                  
  1435                                  ;no heap support
  1436 000002B3 48AD                    lodsq
  1437 000002B5 4885C0                  test rax,rax
  1438 000002B8 0F8536FEFFFF            jnz .fail
  1439 000002BE 48AD                    lodsq
  1440 000002C0 4885C0                  test rax,rax
  1441 000002C3 0F852BFEFFFF            jnz .fail
  1442                                  
  1443 000002C9 AD                      lodsd
  1444 000002CA AD                      lodsd	;datadir cnt
  1445                                  
  1446 000002CB C1E003                  shl eax,3
  1447 000002CE 4801C6                  add rsi,rax		;skip datadir
  1448                                  
  1449 000002D1 4889FD                  mov rbp,rdi
  1450                                  
  1451                                  .makestk:
  1452                                  
  1453                                  
  1454 000002D4 4881EF00100000          sub rdi,PAGE_SIZE
  1455 000002DB E806020000              call PmmAlloc
  1456 000002E0 49B803000000000000-     mov r8,0x80000000_00000003
  1457 000002E9 80                 
  1458 000002EA 4889C2                  mov rdx,rax
  1459 000002ED 4889F9                  mov rcx,rdi
  1460 000002F0 E836020000              call MapPage
  1461                                  
  1462 000002F5 FFCB                    dec ebx
  1463 000002F7 75DB                    jnz .makestk
  1464                                  
  1465                                  ;change rsp just before jmp to krnl
  1466                                  
  1467                                  
  1468                                  ;map header to vbase
  1469                                  
  1470 000002F9 488B4C2408              mov rcx,[rsp+peinfo.vbase]
  1471 000002FE 488B1424                mov rdx,[rsp+peinfo.headerpmm]
  1472 00000302 49B801000000000000-     mov r8,0x80000000_00000001
  1473 0000030B 80                 
  1474 0000030C E81A020000              call MapPage
  1475                                  
  1476                                  
  1477                                  ;process sections
  1478                                  
  1479                                  .section:
  1480                                  
  1481 00000311 48AD                    lodsq	;name
  1482 00000313 AD                      lodsd	;originsize
  1483                                  ;xor rax,rax
  1484 00000314 488B7C2408              mov rdi,[rsp+peinfo.vbase]
  1485 00000319 89442418                mov [rsp+peinfo.sec_size],eax
  1486 0000031D 89C1                    mov ecx,eax		;originsize
  1487                                  
  1488 0000031F AD                      lodsd	;RVA
  1489 00000320 4801C7                  add rdi,rax		;section vbase
  1490                                  
  1491 00000323 AD                      lodsd	;size
  1492 00000324 85C0                    test eax,eax
  1493 00000326 89442418                mov [rsp+peinfo.sec_size],eax	;size in file
  1494 0000032A 0F45C8                  cmovnz ecx,eax
  1495                                  
  1496                                  
  1497                                  
  1498                                  
  1499 0000032D 66F7C1FF0F              test cx,(PAGE_SIZE-1)
  1500 00000332 7406                    jz .section_aligned
  1501                                  
  1502 00000334 81C100100000            add ecx,PAGE_SIZE
  1503                                  
  1504                                  .section_aligned:
  1505 0000033A 89CB                    mov ebx,ecx		;size in memory
  1506                                  
  1507 0000033C AD                      lodsd	;offset
  1508 0000033D 4881C60C000000          add rsi,0x0C
  1509                                  ;or ebx,eax		;rbx	( size<<32 ) | offset
  1510 00000344 8944241C                mov [rsp+peinfo.sec_off],eax
  1511                                  
  1512 00000348 AD                      lodsd	;attrib
  1513 00000349 C1E810                  shr eax,16
  1514 0000034C 0FBAE009                bt eax,9	;discard
  1515 00000350 7275                    jc .section_discard
  1516 00000352 6689442416              mov [rsp+peinfo.sec_attrib],ax
  1517                                  
  1518 00000357 49B803000000000000-     mov r8,0x80000000_00000003
  1519 00000360 80                 
  1520 00000361 C1EB0C                  shr ebx,12		;page count
  1521 00000364 4889F9                  mov rcx,rdi		;vbase
  1522 00000367 4889DA                  mov rdx,rbx
  1523 0000036A E89A020000              call VirtualAlloc
  1524                                  
  1525                                  
  1526                                  
  1527 0000036F 448B442418              mov r8d,[rsp+peinfo.sec_size]	;size
  1528 00000374 8B54241C                mov edx,[rsp+peinfo.sec_off]	;offset
  1529 00000378 4585C0                  test r8d,r8d
  1530 0000037B 4889F9                  mov rcx,rdi		;dst
  1531 0000037E 7405                    jz .nofile
  1532 00000380 E8EA000000              call ReadFile
  1533                                  
  1534                                  .nofile:
  1535                                  
  1536 00000385 895C2418                mov [rsp+peinfo.sec_size],ebx	;pagecount
  1537 00000389 668B542416              mov dx,WORD [rsp+peinfo.sec_attrib]
  1538 0000038E 4831DB                  xor rbx,rbx
  1539                                  
  1540 00000391 660FBAE20D              bt dx,13	;X
  1541 00000396 7205                    jc .attrib_X
  1542 00000398 480FBAEB3F              bts rbx,63
  1543                                  
  1544                                  .attrib_X:
  1545                                  
  1546 0000039D 660FBAE20F              bt dx,15	;W
  1547                                  
  1548 000003A2 7305                    jnc .attrib_W
  1549 000003A4 480FBAEB01              bts rbx,1
  1550                                  
  1551                                  .attrib_W:
  1552                                  
  1553 000003A9 48FFC3                  inc rbx
  1554                                  
  1555                                  .section_attrib:
  1556 000003AC 4889F9                  mov rcx,rdi
  1557 000003AF 4831D2                  xor rdx,rdx
  1558 000003B2 4989D8                  mov r8,rbx
  1559 000003B5 E871010000              call MapPage
  1560                                  
  1561                                  
  1562 000003BA 4881C700100000          add rdi,PAGE_SIZE
  1563 000003C1 FF4C2418                dec DWORD [rsp+peinfo.sec_size]
  1564 000003C5 75E5                    jnz .section_attrib
  1565                                  
  1566                                  .section_discard:
  1567                                  
  1568 000003C7 66FF4C2414              dec WORD [rsp+peinfo.section]
  1569 000003CC 0F853FFFFFFF            jnz .section
  1570                                  
  1571                                  
  1572                                  ;unmap CMN_BUF
  1573 000003D2 48B9001001000080FF-     mov rcx,CMN_BUF_VBASE
  1574 000003DB FF                 
  1575 000003DC 4831D2                  xor rdx,rdx
  1576 000003DF 4D31C0                  xor r8,r8
  1577 000003E2 E844010000              call MapPage
  1578                                  
  1579                                  ;xor rdx,rdx
  1580 000003E7 488B4C2408              mov rcx,[rsp+peinfo.vbase]
  1581 000003EC 8B542410                mov edx,[rsp+peinfo.entry]
  1582 000003F0 4889EC                  mov rsp,rbp
  1583 000003F3 4801CA                  add rdx,rcx
  1584 000003F6 4881EC20000000          sub rsp,0x20
  1585                                  
  1586                                  ;	at 0x2a6f
  1587                                  
  1588 000003FD 48FFD2                  call rdx	;rcx module base
  1589                                  
  1590 00000400 90                      nop
  1591                                  
  1592                                  BugCheck:
  1593 00000401 66BA9200                mov dx,0x92
  1594 00000405 EC                      in al,dx
  1595 00000406 0C01                    or al,1
  1596 00000408 EE                      out dx,al
  1597 00000409 F4                      hlt
  1598 0000040A EBF5                    jmp BugCheck
  1599                                  
  1600                                  
  1601                                  ;ReadSector dst,LBA,cnt
  1602                                  ;TODO get ports from PCI
  1603                                  ReadSector:
  1604                                  
  1605 0000040C 57                      push rdi
  1606                                  
  1607                                  
  1608 0000040D 4989D1                  mov r9,rdx		;LBA
  1609 00000410 4C89C0                  mov rax,r8		;cnt
  1610 00000413 4889CF                  mov rdi,rcx		;dst
  1611                                  
  1612 00000416 66BAF201                mov dx,0x1F2
  1613 0000041A EE                      out dx,al
  1614                                  
  1615 0000041B 4C89C8                  mov rax,r9
  1616 0000041E 66FFC2                  inc dx
  1617 00000421 EE                      out dx,al		;0x1F3
  1618                                  
  1619 00000422 C1E808                  shr eax,8
  1620 00000425 66FFC2                  inc dx
  1621 00000428 EE                      out dx,al		;0x1F4
  1622                                  
  1623 00000429 C1E808                  shr eax,8
  1624 0000042C 66FFC2                  inc dx
  1625 0000042F EE                      out dx,al		;0x1F5
  1626                                  
  1627 00000430 C1E808                  shr eax,8
  1628 00000433 66FFC2                  inc dx
  1629 00000436 0FBAF004                btr eax,4
  1630 0000043A 0CE0                    or al,0xE0
  1631 0000043C EE                      out dx,al		;0x1F6
  1632                                  
  1633 0000043D B020                    mov al,0x20
  1634 0000043F 66FFC2                  inc dx
  1635 00000442 EE                      out dx,al		;0x1F7
  1636                                  
  1637 00000443 31C9                    xor ecx,ecx
  1638                                  .wait:
  1639                                  
  1640 00000445 FFC1                    inc ecx
  1641 00000447 7420                    jz .fail
  1642                                  
  1643 00000449 F390                    pause
  1644                                  
  1645 0000044B EC                      in al,dx
  1646 0000044C A880                    test al,0x80
  1647 0000044E 75F5                    jnz .wait
  1648 00000450 A821                    test al,0010_0001_b
  1649 00000452 7515                    jnz .fail
  1650 00000454 A808                    test al,8
  1651 00000456 74ED                    jz .wait
  1652                                  
  1653 00000458 490FB6C8                movzx rcx,r8b
  1654 0000045C 66BAF001                mov dx,0x1F0
  1655 00000460 48C1E108                shl rcx,8		;*256
  1656 00000464 F3666D                  rep insw
  1657                                  
  1658 00000467 5F                      pop rdi
  1659                                  
  1660 00000468 C3                      ret
  1661                                  
  1662                                  .fail:
  1663 00000469 E893FFFFFF              call BugCheck
  1664 0000046E CC                      int3
  1665                                  
  1666                                  
  1667                                  
  1668                                  
  1669                                  ;ReadFile dst,off,size
  1670                                  ;NOTE works but low efficiency
  1671                                  ;return size
  1672                                  ReadFile:
  1673                                  
  1674 0000046F 66F7C2FF01              test dx,0x1FF
  1675 00000474 756A                    jnz .fail
  1676                                  
  1677 00000476 6641F7C0FF01            test r8w,0x1FF
  1678 0000047C 7562                    jnz .fail
  1679                                  
  1680 0000047E 4150                    push r8		;size
  1681 00000480 48C1EA09                shr rdx,9	;in sector
  1682 00000484 49C1E809                shr r8,9	;in sector
  1683                                  
  1684 00000488 56                      push rsi
  1685 00000489 57                      push rdi
  1686 0000048A 53                      push rbx
  1687                                  
  1688                                  
  1689 0000048B 4889D6                  mov rsi,rdx		;offset in sector
  1690 0000048E 4889CF                  mov rdi,rcx		;dst
  1691 00000491 4C89C3                  mov rbx,r8		;size in sector
  1692                                  
  1693                                  
  1694                                  .read:
  1695 00000494 4831D2                  xor rdx,rdx
  1696                                  ;mov r9,HIGHADDR+SYSINFO_BASE+sysinfo.FAT_cluster
  1697 00000497 4889F0                  mov rax,rsi
  1698 0000049A 41F774244C              div DWORD [r12+sysinfo.FAT_cluster]
  1699                                  
  1700 0000049F 4889D1                  mov rcx,rdx	;remainder
  1701 000004A2 418B448450              mov eax,[r12+sysinfo.PE_filekrnl+4*rax]
  1702                                  
  1703 000004A7 2D02000000              sub eax,2
  1704                                  
  1705 000004AC 41F764244C              mul DWORD [r12+sysinfo.FAT_cluster]
  1706                                  
  1707 000004B1 85D2                    test edx,edx
  1708 000004B3 89C2                    mov edx,eax
  1709 000004B5 7529                    jnz .fail
  1710                                  
  1711                                  
  1712 000004B7 4103542448              add edx,[r12+sysinfo.FAT_data]	;edx sector of target cluster
  1713 000004BC 4D31C0                  xor r8,r8
  1714 000004BF 01CA                    add edx,ecx		;target sector
  1715 000004C1 49FFC0                  inc r8
  1716 000004C4 4889F9                  mov rcx,rdi
  1717 000004C7 E840FFFFFF              call ReadSector
  1718                                  
  1719 000004CC 4881C700020000          add rdi,SECTOR_SIZE
  1720 000004D3 48FFC6                  inc rsi
  1721                                  
  1722 000004D6 48FFCB                  dec rbx
  1723 000004D9 75B9                    jnz .read
  1724                                  
  1725                                  
  1726 000004DB 5B                      pop rbx
  1727 000004DC 5F                      pop rdi
  1728 000004DD 5E                      pop rsi
  1729 000004DE 58                      pop rax		;size
  1730                                  
  1731 000004DF C3                      ret
  1732                                  
  1733                                  .fail:
  1734 000004E0 E81CFFFFFF              call BugCheck
  1735 000004E5 CC                      int3
  1736                                  
  1737                                  
  1738                                  PmmAlloc:
  1739                                  
  1740 000004E6 56                      push rsi
  1741 000004E7 53                      push rbx
  1742                                  
  1743                                  ;xor rcx,rcx
  1744 000004E8 48BE100A00000080FF-     mov rsi,HIGHADDR+SYSINFO_BASE+sysinfo.PMM_wmp_vbase
  1745 000004F1 FF                 
  1746 000004F2 48AD                    lodsq
  1747 000004F4 4889C3                  mov rbx,rax
  1748 000004F7 AD                      lodsd
  1749 000004F8 89C1                    mov ecx,eax
  1750 000004FA 4889DE                  mov rsi,rbx
  1751 000004FD 48C1E10B                shl rcx,12-1
  1752                                  
  1753                                  .find:
  1754 00000501 66AD                    lodsw
  1755 00000503 660FBAE00F              bt ax,15
  1756 00000508 7208                    jc .found
  1757                                  
  1758 0000050A E2F5                    loop .find
  1759                                  
  1760 0000050C E8F0FEFFFF              call BugCheck
  1761 00000511 CC                      int3
  1762                                  
  1763                                  .found:
  1764                                  
  1765 00000512 4881EE02000000          sub rsi,2
  1766 00000519 31D2                    xor edx,edx
  1767 0000051B 4889F0                  mov rax,rsi
  1768 0000051E 668916                  mov [rsi],dx
  1769                                  
  1770 00000521 4829D8                  sub rax,rbx
  1771                                  
  1772 00000524 48C1E00B                shl rax,12-1
  1773                                  
  1774 00000528 5B                      pop rbx
  1775 00000529 5E                      pop rsi
  1776                                  
  1777 0000052A C3                      ret
  1778                                  
  1779                                  
  1780                                  ;MapAddress VirtualAddr,PhysicalAddr,attrib
  1781                                  ;PMM==0	change attrib
  1782                                  ;attrib==0 unmap
  1783                                  MapPage:
  1784                                  
  1785                                  
  1786                                  
  1787 0000052B B800000040              mov eax,0x40000000		;1G
  1788                                  
  1789 00000530 39C1                    cmp ecx,eax
  1790 00000532 7353                    jae .fail
  1791                                  
  1792 00000534 480FBAE12F              bt rcx,47
  1793 00000539 734C                    jnc .fail
  1794                                  
  1795 0000053B 53                      push rbx
  1796 0000053C 56                      push rsi
  1797 0000053D 57                      push rdi
  1798                                  
  1799 0000053E 4889D3                  mov rbx,rdx		;PMM
  1800                                  ;xor rsi,rsi
  1801                                  
  1802 00000541 4D85C0                  test r8,r8
  1803 00000544 490F44D8                cmovz rbx,r8
  1804                                  
  1805 00000548 89CE                    mov esi,ecx		;VA within 1G
  1806                                  
  1807                                  
  1808 0000054A 48BF006000000080FF-     mov rdi,HIGHADDR+PDT0
  1809 00000553 FF                 
  1810 00000554 4889F0                  mov rax,rsi
  1811                                  ;xor dil,dil
  1812 00000557 48C1E815                shr rax,21
  1813                                  
  1814 0000055B 488D3CC7                lea rdi,[rdi+rax*8]
  1815                                  
  1816 0000055F 480FBA2700              bt QWORD [rdi],0
  1817 00000564 7326                    jnc .newPT
  1818                                  
  1819 00000566 488B07                  mov rax,[rdi]
  1820 00000569 48BF807000000080FF-     mov rdi,HIGHADDR+PT_MAP_PT
  1821 00000572 FF                 
  1822 00000573 48AB                    stosq
  1823                                  
  1824 00000575 48BF000001000080FF-     mov rdi,TMP_PT_VBASE
  1825 0000057E FF                 
  1826 0000057F 0F013F                  invlpg [rdi]
  1827                                  
  1828 00000582 E944000000              jmp .next
  1829                                  
  1830                                  .fail:
  1831 00000587 E875FEFFFF              call BugCheck
  1832                                  
  1833                                  
  1834                                  .newPT:
  1835                                  
  1836 0000058C 4885DB                  test rbx,rbx
  1837 0000058F 74F6                    jz .fail
  1838                                  
  1839 00000591 4D85C0                  test r8,r8
  1840 00000594 746F                    jz .end
  1841                                  
  1842 00000596 4150                    push r8
  1843                                  
  1844                                  ;alloc new PT
  1845 00000598 E849FFFFFF              call PmmAlloc
  1846 0000059D B003                    mov al,3
  1847 0000059F 48AB                    stosq
  1848                                  
  1849 000005A1 48BF807000000080FF-     mov rdi,HIGHADDR+PT_MAP_PT
  1850 000005AA FF                 
  1851 000005AB 48AB                    stosq
  1852                                  
  1853 000005AD 48BF000001000080FF-     mov rdi,TMP_PT_VBASE
  1854 000005B6 FF                 
  1855 000005B7 4831C0                  xor rax,rax
  1856 000005BA 0F013F                  invlpg [rdi]
  1857                                  ;mov rcx,PAGE_SIZE/8
  1858 000005BD 48AB                    stosq
  1859                                  
  1860 000005BF 48BF000001000080FF-     mov rdi,TMP_PT_VBASE
  1861 000005C8 FF                 
  1862 000005C9 4158                    pop r8
  1863                                  
  1864                                  .next:
  1865 000005CB 48C1EE0C                shr rsi,12
  1866 000005CF 480FB7C6                movzx rax,si
  1867 000005D3 6625FF01                and ax,0x01FF
  1868                                  
  1869 000005D7 488D3CC7                lea rdi,[rdi+rax*8]
  1870                                  
  1871 000005DB 4885DB                  test rbx,rbx
  1872 000005DE 751F                    jnz .set
  1873                                  
  1874 000005E0 488B1F                  mov rbx,[rdi]
  1875                                  
  1876 000005E3 480FBAF33F              btr rbx,63
  1877 000005E8 6681E300F0              and bx,0xF000
  1878                                  
  1879 000005ED 4D85C0                  test r8,r8
  1880                                  
  1881 000005F0 0F013B                  invlpg [rbx]
  1882                                  
  1883 000005F3 750A                    jnz .set
  1884                                  
  1885 000005F5 4831C0                  xor rax,rax
  1886 000005F8 48AB                    stosq
  1887                                  ;PmmFree(rbx)
  1888                                  
  1889 000005FA E906000000              jmp .end
  1890                                  
  1891                                  .set:
  1892                                  
  1893                                  ;ASSERT(rbx is valid PMM)
  1894                                  ;ASSERT(r8 is valid attrib)
  1895 000005FF 4C09C3                  or rbx,r8
  1896 00000602 48871F                  xchg [rdi],rbx
  1897                                  
  1898                                  ;PmmFree(rbx)
  1899                                  
  1900                                  
  1901                                  .end:
  1902                                  
  1903 00000605 5F                      pop rdi
  1904 00000606 5E                      pop rsi
  1905 00000607 5B                      pop rbx
  1906                                  
  1907 00000608 C3                      ret
  1908                                  
  1909                                  ;VirtualAlloc vbase,pagecount,attrib
  1910                                  VirtualAlloc:
  1911                                  
  1912 00000609 56                      push rsi
  1913 0000060A 57                      push rdi
  1914 0000060B 53                      push rbx
  1915                                  
  1916 0000060C 4C89C6                  mov rsi,r8		;attrib
  1917 0000060F 4889CF                  mov rdi,rcx		;vbase
  1918 00000612 4889D3                  mov rbx,rdx		;pagecount
  1919                                  
  1920                                  .map:
  1921 00000615 E8CCFEFFFF              call PmmAlloc
  1922 0000061A 4989F0                  mov r8,rsi		;attrib
  1923 0000061D 4889F9                  mov rcx,rdi		;vaddr
  1924 00000620 4889C2                  mov rdx,rax		;paddr
  1925 00000623 E803FFFFFF              call MapPage
  1926                                  
  1927 00000628 4881C700100000          add rdi,PAGE_SIZE
  1928                                  
  1929 0000062F 48FFCB                  dec rbx
  1930 00000632 75E1                    jnz .map
  1931                                  
  1932                                  
  1933                                  
  1934 00000634 5B                      pop rbx
  1935 00000635 5F                      pop rdi
  1936 00000636 5E                      pop rsi
  1937                                  
  1938 00000637 C3                      ret
  1939                                  
  1940                                  
